name: 'ðŸ¤– Gemini Auto-Fixer (Loop)'

on:
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
        type: string
      iteration:
        description: 'Current Iteration'
        required: false
        default: '1'
        type: string
      bypass_pacing:
        description: 'Bypass Smart Pacing (Force Run)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: gemini-fix-loop-${{ github.event.inputs.pr_number || github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  fix-loop:
    runs-on: ubuntu-latest
    timeout-minutes: 90 # Extended timeout to allow for Smart Pacing sleep
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.review.user.login == 'coderabbitai[bot]' &&
       contains(fromJSON('["commented","changes_requested","approved"]'), github.event.review.state) && 
       github.event.pull_request.head.repo.full_name == github.repository)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || github.event.pull_request.head.ref }}
          fetch-depth: 2 # Needed to check HEAD commit author
          token: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: ðŸ›‘ Smart Pacing (Rate Limit Protection)
        id: pacing
        if: github.event.inputs.bypass_pacing != 'true'
        env:
           GH_TOKEN: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Last commit author: $LAST_COMMIT_AUTHOR"
          
          if [[ "$LAST_COMMIT_AUTHOR" == "Gemini Fixer [bot]" ]]; then
            echo "::warning::Last commit was by Bot. We are in a loop."
            echo "Sleeping for 65 minutes to ensure we hit the NEXT rate limit window (2 reviews/hour)."
            echo "CodeRabbit OSS Plan: 2 reviews/hour limit."
            
            # Sleep for 65 minutes (3900 seconds)
            sleep 3900
          else
            echo "Last commit was by User ($LAST_COMMIT_AUTHOR). Proceeding immediately."
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch all active comments
        env:
          GH_TOKEN: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.inputs.pr_number || github.event.pull_request.number }}
        run: |
          # Fetch review comments using pagination to get EVERYTHING
          gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/comments" --paginate > comments.json

      - name: Run Gemini Fixer
        id: fixer
        env:
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: 'gemini-3-flash-preview'
          COMMENTS_FILE: 'comments.json'
          SUMMARY_FILE: 'fix_summary.md'
          ITERATION_COUNT: ${{ github.event.inputs.iteration || '1' }}
          GH_TOKEN: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ¤– Gemini Senior AI Analysis (Iteration ${{ env.ITERATION_COUNT }})" > fix_summary.md
          
          # Run the fixer script
          npx tsx scripts/gemini-fixer.ts
          
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes generated by Gemini."
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Post the summary as a PR comment if something was actually added to the summary
            if [ -f fix_summary.md ] && [ $(wc -c < fix_summary.md) -gt 50 ]; then
               gh pr comment "${{ github.event.inputs.pr_number || github.event.pull_request.number }}" --body-file fix_summary.md || echo "Failed to post PR comment"
            fi
          fi

      - name: Commit and Push Fix
        if: steps.fixer.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.event_name == 'workflow_dispatch' && github.ref_name || github.event.pull_request.head.ref }}
        run: |
          git config --global user.name "Gemini Fixer [bot]"
          git config --global user.email "gemini-fixer@smalltalk.community"
          git add .
          CHANGED_FILES=$(git diff --name-only --cached | wc -l)
          git commit -m "fix: iterative Gemini fix (Iteration ${{ github.event.inputs.iteration || '1' }}) - $CHANGED_FILES files"
          git push origin -- "$BRANCH_NAME"
          
          echo "âœ… Fixes pushed. CodeRabbit should review this new commit in the next window."