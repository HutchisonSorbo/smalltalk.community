# Daily Security & Compliance Audit Report
**Date:** 2026-01-26
**Time:** 6:00 AM AEST
**Commit:** [Current HEAD]

## Executive Summary
**Status:** ðŸ”´ FAIL

**Issues Found:**
- Critical (P1): 4
- High (P2): 1
- Medium (P3): 0
- Low (P4): 0

**Compliance:**
- Child Safe Standards: âŒ (Age verification bypass, Privacy defaults)
- Privacy Act: âŒ (Default settings not restrictive for minors)
- WCAG 2.2 AA: âœ… (Accessibility panel present, contrast seems okay)
- Security: âŒ (CSP unsafe-inline)

---

## ðŸš¨ Critical Issues (P1)

### 1. OAuth Age Verification Bypass
**Category:** Child Safety
**Location:** `app/api/auth/callback/route.ts` -> `app/onboarding/page.tsx`
**CVE:** N/A

**Description:**
Users signing up via OAuth (e.g., Google) bypass the `register` route where age verification occurs. They are redirected to the onboarding flow (`/onboarding`), specifically the "Profile Setup" step. This step currently **does not** collect or validate Date of Birth if it is missing from the OAuth provider's data. This allows users under 13 to access the platform.

**Risk:**
Violation of platform Terms and Child Safe Standards. Users <13 could be exposed to age-inappropriate content or interactions.

**Fix:**
Modify `components/onboarding/ProfileSetup.tsx` to require Date of Birth if missing, and `app/api/onboarding/profile/route.ts` to validate and enforce the 13+ limit.

### 2. Unsafe Privacy Defaults for Minors
**Category:** Privacy/Child Safety
**Location:** `app/api/auth/register/route.ts`
**CVE:** N/A

**Description:**
When a minor (13-17) registers via email/password, the `users` table record is created with the default `messagePrivacy` setting, which is defined as `'everyone'` in the database schema. The code does not explicitly override this to a more restrictive setting (e.g., `'verified_only'` or `'nobody'`) for minors.

**Risk:**
Minors are exposed to messages from strangers by default, violating safety-by-design principles and the requirement for "most restrictive default settings".

**Fix:**
Update `app/api/auth/register/route.ts` to explicitly set `messagePrivacy` to `'verified_only'` when `isMinor` is true.

### 3. Minors Can Select Public Profile Visibility
**Category:** Privacy
**Location:** `components/onboarding/PrivacyPreferences.tsx`
**CVE:** N/A

**Description:**
The onboarding privacy selection step allows all users, including minors, to select "Public" profile visibility. The prompt requirements state that for users <18, profiles "Cannot be public by default" and ideally should be restricted.

**Risk:**
Minors may inadvertently or intentionally make their profiles public, exposing their PII (location, bio) to unauthenticated users.

**Fix:**
Modify `components/onboarding/PrivacyPreferences.tsx` to detect `isMinor` and disable/remove the "Public" option, enforcing "Community Members" or "Private".

### 4. Content Security Policy (CSP) Weakness
**Category:** Security
**Location:** `next.config.mjs`
**CVE:** N/A

**Description:**
The configured Content Security Policy includes `'unsafe-inline'` for `script-src`. While common in Next.js development, this weakens protection against XSS attacks.

**Risk:**
Increased vulnerability to Cross-Site Scripting (XSS).

**Fix:**
Remove `'unsafe-inline'` where possible or implement a nonce-based CSP (requires Middleware adaptation). For this fix, we will attempt to restrict it or ensure `upgrade-insecure-requests` is active.

---

## âš ï¸ High Priority (P2)

### 1. Client-Side Only Age Warning
**Category:** Child Safety
**Location:** `app/login/page.tsx`

**Description:**
The login/signup page performs a client-side check for age. For users <18, it shows a warning dialog but allows them to proceed. For users <13, it relies on the server-side check (which exists in `register` route, but see P1 about OAuth). The client-side UX for <13 is not explicit blocking until submission.

**Risk:**
Poor UX and reliance on server-side validation (which is good practice, but client-side could be more robust).

**Fix:**
Enhance `app/login/page.tsx` to explicitly block submission if age < 13 is detected client-side.

---

## Compliance Details

### Child Safe Standards
- **Age Verification:** Failed (OAuth bypass).
- **Privacy:** Failed (Defaults to public/everyone).

### Privacy Act
- **Data Minimisation:** Generally okay.
- **Privacy Policy:** Missing prominent link on signup.

### Accessibility
- **Status:** Basic checks passed. `AccessibilityPanel` is present.

---

## Recommendations

### Immediate (24h)
1.  Implement DOB collection and validation in Onboarding (Profile Setup).
2.  Enforce restrictive privacy defaults for minors in Registration and Onboarding APIs.
3.  Restrict privacy options in UI for minors.

### Short-term (1 week)
1.  Implement strict nonce-based CSP.
2.  Add `parent_email` collection for under-16s (if required by updated policy).

---
